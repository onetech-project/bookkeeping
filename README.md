# DEPLOYMENT
## SETUP SERVER
### INSTALL DEPENDENCIES
```bash
$ curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
$ sudo apt update
$ sudo apt install -y nginx mysql-server git node certbot python3-certbot-nginx
```

### Setup Workspace
```bash
$ mkdir ~/app
$ cd ~/app
```

### Clone Project
```bash
$ git clone https://github.com/onetech-project/bookkeeping.git
$ cd bookkeeping/backend && npm i
$ cd bookkeeping/frontend && npm i
$ cd bookkeeping/backups && npm i
```

### Setup DB
```bash
$ sudo mysql_secure_installation
$ sudo systemctl status mysql
$ sudo mysql -u root -p
```
```sql
CREATE USER 'bk_app'@'localhost' IDENTIFIED WITH mysql_native_password BY 'password';
GRANT ALL PRIVILEGES ON bookkeeping.* TO 'bk_app'@'localhost';
GRANT SELECT, LOCK TABLES, SHOW VIEW, EVENT, TRIGGER ON *.* TO 'bk_app'@'localhost';
GRANT RELOAD, PROCESS ON *.* TO 'backupuser'@'localhost';
FLUSH PRIVILEGES;
```

### Setup PM2
```bash
$ sudo npm i -g pm2
$ pm2 start ecosystem.config.js
$ pm2 save
$ pm2 startup
```

### Setup Nginx
```bash
$ sudo nano /etc/nginx/sites-available/domain.com
```

#### Add scripts below then save and exit:

```
server {
    server_name domain.com www.domain.com;

    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /.well-known/acme-challenge/ {
        root /var/www/html;
        try_files $uri =404;
    }
}
```

#### Install SSL
```bash
$ sudo certbot --nginx -d domain.com -d www.domain.com
```

### Setup UFW
```bash
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
sudo ufw status
```

### Backup
* Create client credentials for Desktop from Google Console [See this](https://developers.google.com/workspace/guides/create-credentials#oauth-client-id)
* Store the credentials.json to `~/app/bookeeping/backups`
* run this script ```bash node ~/app/bookeeping/backups/server.js```
* For first time run, you need to open an url that generated by code and authorize it, then paste the given code (at the redirect url) to the terminal 
* then run this script
```bash
$ crontab -e
```
* type 1 for using nano if prompted
* Add this script to the bottom of the file
```
0 2 * * * sh ~/app/bookeeping/backups/backup_db.sh bk_app <YOUR_DB_PASSWORD> bookkeeping backup_db <YOUR_GOOGLE_DRIVE_FOLDER_ID> >> ~/app/bookeeping/backups/backup.log 2>&1
@reboot sh ~/app/bookeeping/backups/backup_db.sh bk_app <YOUR_DB_PASSWORD> bookkeeping backup_db <YOUR_GOOGLE_DRIVE_FOLDER_ID> >> ~/app/bookeeping/backups/backup.log 2>&1
```
